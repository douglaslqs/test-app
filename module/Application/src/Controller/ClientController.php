<?php
/**
 * @link      http://github.com/zendframework/ZendSkeletonApplication for the canonical source repository
 * @copyright Copyright (c) 2005-2016 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd New BSD License
 */

namespace Application\Controller;

use Zend\Mvc\Controller\AbstractRestfulController;
use Zend\View\Model\JsonModel;
use Application\Model\ClientTable;
use Application\Service\ResponseService;
use Application\Service\LoggerService as Logger;

class ClientController extends AbstractRestfulController
{
    private $clientTable;
    private $form;
    private $responseService;
    private $filterService;
    private $logger;
    private $setBcrypt;

    public function __construct(ResponseService $responseService, ClientTable $clientTable)
    {
        $this->responseService = $responseService;
        $this->clientTable = $clientTable;
    }

    public function indexAction()
    {
        return new JsonModel(array("ação não encontrada"));
    }

    public function getAction()
    {
        $request = $this->getRequest();
        if($request->isGet()){
            $arrParams = $request->getQuery()->toArray();
            try {
                if(!empty($arrParams)){
                    $arrParams = array_change_key_case($arrParams, CASE_LOWER);
                }
                $client = $this->clientTable->fetch($arrParams);
                if(!empty($client)){
                    $this->responseService->setData($client);
                    $this->responseService->setCode(ResponseService::CODE_SUCCESS);
                } else {
                    $this->responseService->setCode(ResponseService::CODE_QUERY_EMPTY);
                }
            } catch (Exception $e) {
                $this->responseService->setCode(ResponseService::CODE_ERROR);
                $this->logger->setMethodAndLine(__METHOD__, __LINE__);
                $this->logger->save(Logger::LOG_APPLICATION, Logger::CRITICAL,$e->getMessage());
            }
        } else {
            $this->responseService->setCode(ResponseService::CODE_METHOD_INCORRECT);
        }
        return new JsonModel($this->responseService->getArrayCopy());
    }

    public function addAction()
    {
    	$request = $this->getRequest();
        if ($request->isPost()) {
            $arrParams = $request->getPost()->toArray();
            $arrParams = array_change_key_case($arrParams, CASE_LOWER);
            try {
                $boolUpdate = false;
                $typeDocument = isset($arrParams['type']) ? $arrParams['type'] : null;
                $this->form->addInputFilter($boolUpdate, $typeDocument);
                $this->form->setData($arrParams);
                if ($this->form->isValid()) {
                    $arrParams = $this->filterService->setData($arrParams)->getData();
                    $client = $this->clientTable->fetchRow($arrParams);
                    $cpfExist = $this->clientTable->fetchRow(array('document' => $arrParams['document']));
                    if (empty($client) && empty($cpfExist)) {
                        $arrParams['password'] = $this->bcrypt->create($arrParams['password']);
                        $returnInsert = $this->clientTable->insert($arrParams);
                        if ($returnInsert !== 1) {
                            $this->responseService->setCode(ResponseService::CODE_ERROR);
                            $this->logger->setMethodAndLine(__METHOD__, __LINE__);
                            $this->logger->save(Logger::LOG_APPLICATION,Logger::ALERT,$returnInsert);
                        } else {
                            $this->responseService->setCode(ResponseService::CODE_SUCCESS);
                        }
                    } else {
                        if (is_array($client) || is_array($cpfExist)) {
                            $this->responseService->setCode(ResponseService::CODE_ALREADY_EXISTS);
                            $message = $this->responseService->getMessage();
                            if (!empty($cpfExist)) {
                                $message .= " - Document already";
                            }
                            if (!empty($client)) {
                                $message .= " - Email already";
                            }
                            $this->responseService->setMessage($message);
                        } else {
                            $this->responseService->setCode(ResponseService::CODE_ERROR);
                            $this->logger->setMethodAndLine(__METHOD__, __LINE__);
                            $this->logger->save(Logger::LOG_APPLICATION,Logger::WARNING,$client);
                        }
                    }
                } else {
                    $this->responseService->setData($this->form->getInputFilter()->getMessages());
                    $this->responseService->setCode(ResponseService::CODE_NOT_PARAMS_VALIDATED);
                }
            } catch (Exception $e) {
                $this->responseService->setCode(ResponseService::CODE_ERROR);
                $this->logger->setMethodAndLine(__METHOD__, __LINE__);
                $this->logger->save(Logger::LOG_APPLICATION, Logger::CRITICAL ,$e->getMessage());
            }
        } else {
            $this->responseService->setCode(ResponseService::CODE_METHOD_INCORRECT);
        }
        return new JsonModel($this->responseService->getArrayCopy());
    }

    public function updateAction()
    {
    	$request = $this->getRequest();
        if ($request->isPost()) {
            $arrParams = $request->getPost()->toArray();
            $arrParams = array_change_key_case($arrParams, CASE_LOWER);
            try {
                $boolUpdate = true;
                $this->form->addInputFilter($boolUpdate);
                $this->form->setData($arrParams);
                if ($this->form->isValid()) {
                    $arrParams = $this->filterService->setData($arrParams)->getData();
                    $client = $this->clientTable->fetchRow($arrParams);
                    if (is_array($client) && !empty($client)) {
                        $arrSet = $this->filterService->getArraySet();
                        $arrWhere = $this->filterService->getArrayWhere();
                        if (isset($arrSet['password']) && isset($arrParams['p_password'])) {
                            //VERIFICAR SENHA ANTES DE ATUALIZAR
                            if (password_verify($arrParams['p_password'], $client['password'])) {
                                $arrSet['password'] = $this->bcrypt->create($arrSet['password']);
                            } else {
                                $this->responseService->setCode(ResponseService::CODE_NOT_PARAMS_VALIDATED);
                                $this->responseService->setMessage('Invalid Password!');
                                return new JsonModel($this->responseService->getArrayCopy());
                            }
                        }
                        $returnUpdate = $this->clientTable->update($arrSet,$arrWhere);
                        if (is_numeric($returnUpdate)) {
                            $this->responseService->setCode(ResponseService::CODE_SUCCESS);
                        } else {
                            $this->responseService->setCode(ResponseService::CODE_ERROR);
                            $this->logger->setMethodAndLine(__METHOD__, __LINE__);
                            $this->logger->save(Logger::LOG_APPLICATION,Logger::ALERT,$returnUpdate);
                        }
                    } else {
                        if (is_array($client)) {
                            $this->responseService->setCode(ResponseService::CODE_ALREADY_EXISTS);
                        } else {
                            $this->responseService->setCode(ResponseService::CODE_ERROR);
                            $this->logger->setMethodAndLine(__METHOD__, __LINE__);
                            $this->logger->save(Logger::LOG_APPLICATION,Logger::WARNING,$client);
                        }
                    }
                } else {
                    $this->responseService->setData($this->form->getInputFilter()->getMessages());
                    $this->responseService->setCode(ResponseService::CODE_NOT_PARAMS_VALIDATED);
                }
            } catch (Exception $e) {
                $this->responseService->setCode(ResponseService::CODE_ERROR);
                $this->logger->setMethodAndLine(__METHOD__, __LINE__);
                $this->logger->save(Logger::LOG_APPLICATION, Logger::CRITICAL ,$e->getMessage());
            }
        }
        return new JsonModel($this->responseService->getArrayCopy());
    }

    public function setForm($form)
    {
        $this->form = $form;
    }

    public function setBcrypt($bcrypt)
    {
        $this->bcrypt = $bcrypt;
    }

    public function setFilterService($filterService)
    {
        $this->filterService = $filterService;
    }

    public function setLogger($objLogger)
    {
        $this->logger = $objLogger;
    }
}
